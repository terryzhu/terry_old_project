#include "gdi.h"
UINT16  ( * pFrameBuf)[LCD_XSIZE];//a pointer to a array,we cant use it to p[x][y],study it beacause it's important
static POS pos;
static COLOR color=BLACK;


void LCD_Init()
{
	pFrameBuf=(UINT16 (*)[LCD_XSIZE])LCD_VIDEO_ADDR;
	// 设置C口(VCLK,HSYNC,VSYNC,VM,VD2--VD7)，C1--C4，C10--C15
	rGPCUP = rGPCUP | (0x7E0F<<1); // 禁止上拉电阻
	rGPCCON = (rGPCCON & (~(0x3FFC00FF<<2))) | (0x2AA800AA<<2);    
	// 设置D口(VD10--VD15, VD18--VD23)，D2--D7， D10--D15
	rGPDUP = rGPDUP | (0x3F3F<<2);
	rGPDCON = (rGPDCON & (~(0xFFF0FFF<<4))) | (0xAAA0AAA<<4);

	// CLKVAL=1，即VCLK=HCLK/4=25MHz
	// NMOD=0，TFT屏的VDEN输出设置
	// PNRMODE=3，显示模式--TFT
	// BPPMODE=0x0C，16BPP
	// ENVID=0，关闭显示
	rLCDCON1 = (1<<8)|(0<<7)|(3<<5)|(0x0C<<1)|0; 
	// VBPD=32，垂直不显示周期为33行(前)
	// LINEVAL=479，垂直行数为480行
	// VFPD=9，垂直不显示周期为10行(后)
	// VSPW=0，帧信号(Vsync)宽度为1行
	rLCDCON2 = (32<<24)|(319<<14)|(9<<6)|(0); 
	// HBPD=47，水平不显示周期为48个VCLK(前)
	// HOZVAL=639，水平列数为640列
	// HFPD=15，水平不显示周期为16个VCLK(后)
	rLCDCON3 = (47<<19)|(239<<8)|(15); 
	// HSPW=95，行信号(Hsync)宽度为96个VCLK
	rLCDCON4 = 95;
	// FRM565=1，设置16BBP显示数据格式为5:6:5
	// INVVCLK=0，VCLK下降沿取数
	// INVVLINE=1，Hsync信号取反
	// INVVFRAME=1，Vsync信号取反
	// INVVD=0，VD数据正常 
	// INVVDEN=0，VDEN信号正常
	// INVPWREN=0，LCD_PWREN信号正常
	// INVLEND=0，LEND信号正常
	// PWREN=0，禁止LCD_PWREN信号输出
	// ENLEND=0，禁止LEND信号输出
	// BSWP=0，HWSWP=1，高低字节取反，即低位字节对应于低点像素
	rLCDCON5=(1<<11)|(0<<10)|(1<<9)|(1<<8)|(0<<7)|(0<<6)|(0<<5)|(0<<4)|(0<<3)|(0<<2)|(0<<1)|1;  
	// 设置显示缓冲区--左上角 (FrameBuffer需要字对齐)
	// A31=0，
	// LCDBANK=A30--A22
	// LCDBASEU=A21--A1
	rLCDSADDR1 = ((((UINT32)pFrameBuf) & 0x7FC00000) >>1) | ((((UINT32)pFrameBuf) & 0x003FFFFE) >>1); 
	// 设置显示缓冲区--双屏的第2屏左上角
	// LCDBASEL=A21--A1
	// 不使用虚拟屏功能
	rLCDSADDR2 = (((UINT32)pFrameBuf + 320*240*2) & 0x003FFFFE) >>1; 
	// 设置显示缓冲区--虚拟屏设置
	// OFFSIZE=0，前(单位为半字)
	// PAGEWIDTH=640 (单位为半字)
	rLCDSADDR3 = (0<<11) | (240);
	// 禁止LCD的FIFO中断、帧同步中断
	rLCDINTMSK = rLCDINTMSK | 3;



}

void SetPixel(UINT32 x,UINT32 y,COLOR c)
{
	pFrameBuf[y][x]=c;

}
void LCD_On()
{
	rLCDCON1 = rLCDCON1 | 0x1;
}
void Fill_Screen(UINT16 c)
{
	UINT16  i, j;
	for(i=0; i<GUI_LCM_YMAX; i++)      // 历遍所有行
	{ 
		for(j=0; j<GUI_LCM_XMAX; j++)  // 历遍所有列
		{ 
			SetPixel(j,i,c);    // 填充数据
		}
	}
}




void _line_to(UINT16 x0,UINT16 y0,UINT16 x1,UINT16 y1,UINT16 position)
{
	//int x0=pos.x;
	//int y0=pos.y;
	int dx;
	int dy;
	int dx2;
	int dy2;
	int e;
	int x;
	int y;

	switch (position)
	{
	case 1:
		{
			dx = x1 - x0;
			dy = y0 - y1;
			dx2 = dx << 1;//乘2
			dy2 = dy << 1;//乘2　　

			e = dx; 
			x = x0;
			y = y0;
			for (x = x0; x < x1; x++)
			{
				//PrintF("x:%d   y:%d\n",x,y);
				SetPixel(x,y,color);
				e=e -dy2;
				if (e < 0) 
				{ 
					y--;
					e = e + dx2;
				}
			}
		}

		break;
	case 2:
		{
			dx = x1 - x0;
			dy = y0 - y1;
			dx2 = dx << 1;//乘2
			dy2 = dy << 1;//乘2　　

			e = -dy; 
			x = x0;
			y = y0;

			for (y = y0; y > y1; y--)
			{
				//PrintF("x:%d   y:%d\n",x,y);
				SetPixel(x,y,color);
				e=e + dx2;
				if (e > 0) 
				{ 
					x++;
					e = e - dy2;
				}
			}
		}

		break;
	case 7:
		{
			dx = x1 - x0;
			dy = y1 - y0;
			dx2 = dx << 1;//乘2
			dy2 = dy << 1;//乘2　　

			e = -dy; 
			x = x0;
			y = y0;
			for (y = y0; y < y1; y++)
			{
				//PrintF("x:%d   y:%d\n",x,y);
				SetPixel(x,y,color);
				e=e + dx2;
				if (e > 0) 
				{ 
					x++;
					e = e - dy2;
				}
			}
		}

		break;
	case 8:
		{int dx = x1 - x0;
		int dy = y1 - y0;
		int dx2 = dx << 1;//乘2
		int dy2 = dy << 1;//乘2　　

		int e = -dx; 
		int x = x0;
		int y = y0;
		for (x = x0; x < x1; x++)
		{
			//PrintF("x:%d   y:%d\n",x,y);
			SetPixel(x,y,color);
			e=e +dy2;
			if (e > 0) 
			{ 
				y++;
				e = e - dx2;
			}
		}
		}

		break;
	default:
		break;
	}
	//pos.x=x1;
	//pos.y=y1;
}


unsigned char TitleLine[]=                  
{

	0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0xE0,0x38,0x38,0x38,0x1C,0x38,0x0E,0x38,0x0E,
	0x38,0x0E,0x38,0x0E,0x38,0x0E,0x38,0x1C,0x38,0x78,0x7F,0xE0,0x00,0x00,0x00,0x00,

	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x3C,0x7E,0xFE,
	0x0F,0x04,0x0E,0x00,0x0E,0x00,0x0E,0x00,0x0E,0x00,0x7F,0xE0,0x00,0x00,0x00,0x00,

	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xE0,0x1C,0x70,
	0x38,0x18,0x07,0xF8,0x3E,0x18,0x30,0x18,0x70,0x3B,0x1F,0xFE,0x00,0x00,0x00,0x00,

	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7B,0xCF,0x7B,0xCF,
	0x31,0xCC,0x39,0xCC,0x1B,0xF8,0x1E,0x70,0x0E,0x70,0x0C,0x20,0x00,0x00,0x00,0x00,

	0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x1C,0x00,0x1C,0x00,0x1C,0x00,0x1C,0x00,
	0x1C,0x00,0x1C,0x00,0x1C,0x00,0x1C,0x02,0x1C,0x06,0x7F,0xFC,0x00,0x00,0x00,0x00,

	0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xC0,0x01,0xC0,0x00,0x00,0x0F,0x80,0x0F,0x80,
	0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x1F,0xF8,0x00,0x00,0x00,0x00,

	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x79,0xE0,0x7F,0xF8,
	0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x7E,0x00,0x00,0x00,0x00,

	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xE0,0x0E,0x78,
	0x18,0x1C,0x3F,0xFC,0x3F,0xFC,0x38,0x00,0x1C,0x08,0x0F,0xF0,0x00,0x00,0x00,0x00,

};

unsigned char TitleCircle[]=                  
{

	0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0xE0,0x38,0x38,0x38,0x1C,0x38,0x0E,0x38,0x0E,
	0x38,0x0E,0x38,0x0E,0x38,0x0E,0x38,0x1C,0x38,0x78,0x7F,0xE0,0x00,0x00,0x00,0x00,

	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x3C,0x7E,0xFE,
	0x0F,0x04,0x0E,0x00,0x0E,0x00,0x0E,0x00,0x0E,0x00,0x7F,0xE0,0x00,0x00,0x00,0x00,

	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xE0,0x1C,0x70,
	0x38,0x18,0x07,0xF8,0x3E,0x18,0x30,0x18,0x70,0x3B,0x1F,0xFE,0x00,0x00,0x00,0x00,

	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7B,0xCF,0x7B,0xCF,
	0x31,0xCC,0x39,0xCC,0x1B,0xF8,0x1E,0x70,0x0E,0x70,0x0C,0x20,0x00,0x00,0x00,0x00,

	0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xFC,0x1C,0x06,0x38,0x02,0x70,0x00,0x70,0x00,
	0x70,0x00,0x70,0x00,0x70,0x02,0x38,0x02,0x1C,0x0C,0x0F,0xF0,0x00,0x00,0x00,0x00,

	0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xC0,0x01,0xC0,0x00,0x00,0x0F,0x80,0x0F,0x80,
	0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x1F,0xF8,0x00,0x00,0x00,0x00,

	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x3C,0x7E,0xFE,
	0x0F,0x04,0x0E,0x00,0x0E,0x00,0x0E,0x00,0x0E,0x00,0x7F,0xE0,0x00,0x00,0x00,0x00,

	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xE0,0x0F,0x38,
	0x18,0x1C,0x38,0x00,0x38,0x00,0x38,0x04,0x1C,0x0C,0x0F,0xF0,0x00,0x00,0x00,0x00,

	0x00,0x00,0x00,0x00,0x00,0x80,0x1F,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,
	0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x1F,0xF8,0x00,0x00,0x00,0x00,

	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xE0,0x0E,0x78,
	0x18,0x1C,0x3F,0xFC,0x3F,0xFC,0x38,0x00,0x1C,0x08,0x0F,0xF0,0x00,0x00,0x00,0x00,

};

unsigned char ZJGXName[]=
{
	
	0x01,0x00,0x11,0x00,0x11,0x10,0x1F,0xF8,0x11,0x00,0x21,0x00,0x01,0x04,0xFF,0xFE,
	0x03,0x00,0x05,0x80,0x09,0x40,0x11,0x30,0x21,0x0E,0xC1,0x04,0x01,0x00,0x01,0x00,

	0x01,0x00,0x01,0x00,0x01,0x04,0xFF,0xFE,0x03,0x80,0x05,0x40,0x09,0x20,0x11,0x10,
	0x21,0x0E,0xC1,0x04,0x01,0x00,0x00,0x00,0x24,0x90,0x22,0x48,0x22,0x44,0x40,0x04,

	0x02,0x00,0x01,0x04,0xFF,0xFE,0x00,0x00,0x1F,0xF0,0x10,0x10,0x10,0x10,0x1F,0xF0,
	0x00,0x04,0x7F,0xFE,0x40,0x04,0x4F,0xE4,0x48,0x24,0x48,0x24,0x4F,0xE4,0x40,0x0C,

	0x08,0x80,0x08,0x44,0x0F,0xFE,0x10,0x00,0x10,0x08,0x37,0xFC,0x50,0x00,0x90,0x08,
	0x17,0xFC,0x10,0x00,0x13,0xF8,0x12,0x08,0x12,0x08,0x12,0x08,0x13,0xF8,0x12,0x08
};

void _PrintCharEngine(UINT32 x,UINT32 y, unsigned char * p)
{
	unsigned short int i,j;
	unsigned char  bt;
	for(i=0;i<32;i++)
	{
		bt=0x80;
		for ( j=0;j<8;j++)
		{
			if (p[i]&bt)
			{

				SetPixel(x+j+((i%2)<<3),y+(i>>1),color);

			}
			bt>>=1;
		}

	}
}


void PrintAuthors(UINT32 x,UINT32 y)
{
	unsigned char * p=(	unsigned char * )ZJGXName;
	int i;
	for (i=0;i<4;i++)
	{
		_PrintCharEngine(i*16+x,y,p);
		p+=32;
	}
}


void PrintMenu(UINT32 x,UINT32 y)
{
	unsigned char * pLine=(	unsigned char * )TitleLine;
	int i;
	for (i=0;i<8;i++)
	{
		_PrintCharEngine(i*16+x,y,pLine);
		pLine+=32;
	}

	unsigned char * pCircle=(	unsigned char * )TitleLine;
	y = y + 70;
	x = x - 10;
	for (i=0;i<10;i++)
	{
		_PrintCharEngine(i*16+x,y,pLine);
		pLine+=32;
	}
}



void _LineTo(UINT16 x0,UINT16 y0,UINT16 x,UINT16 y)
{
	int dx = x - x0;
	int dy = y - y0;

	// 1st
	if (dx > 0 && dy < 0)
	{
		if (dx >= -dy)
		{
			// 1
			_line_to(x0,y0,x,y,1);
		}
		else{
			// 2
			_line_to(x0,y0,x,y,2);
		}
	}

	// 2nd
	if (dx < 0 && dy < 0)
	{
		if (-dx >= -dy)
		{
			// 4
			_line_to(x,y,x0,y0,8);
		}
		else{
			// 3
			_line_to(x,y,x0,y0,7);
		}
	}

	// 3rd
	if (dx < 0 && dy > 0)
	{
		if (-dx >= dy)
		{
			// 5
			_line_to(x,y,x0,y0,1);
		}
		else{
			// 6
			_line_to(x,y,x0,y0,2);
		}
	}


	// 4th
	if (dx >= 0 && dy >= 0)
	{
		if (dx >= dy)
		{
			// 8
			_line_to(x0,y0,x,y,8);
		}
		else{
			// 7
			_line_to(x0,y0,x,y,7);
		}
	}
}


void MoveTo(UINT16 x,UINT16 y)
{
	pos.x=x;
	pos.y=y;
}

void LineTo(UINT16 x,UINT16 y)
{
	_LineTo(pos.x,pos.y,x,y);
	MoveTo(x,y);
}

void DrawChar(UINT32 x,UINT32 y,char c)
{
	unsigned char *temp=(	unsigned char * )TitleLine;
	unsigned char *p=temp+((c-'a')<<5);
	_PrintCharEngine(x,y,p);

}

void DrawText(UINT32 x,UINT32 y,char * str)
{
	int i=0;
	int len=StrLen(str);
	for (i=0;i<len;i++)
	{
		DrawChar(x,y,str[i]);
		x+=16;
	}
}




void SetColor(COLOR c)
{
	color=c;
}



void _plot_circle_points(UINT16 xc,UINT16 yc,UINT16 x,UINT16 y,COLOR c)
{
	SetPixel(xc+x,yc+y,c);
	SetPixel(xc-x,yc+y,c);
	SetPixel(xc+x,yc-y,c);
	SetPixel(xc-x,yc-y,c);
	SetPixel(xc+y,yc+x,c);
	SetPixel(xc-y,yc+x,c);
	SetPixel(xc+y,yc-x,c);
	SetPixel(xc-y,yc-x,c);
}

void DrawCircle(UINT16 xc,UINT16 yc,UINT16 radius,COLOR c)
{
	int x,y,p;
	x=0;
	y=radius;
	p=3-2*radius;
	while(x<y) {
		_plot_circle_points(xc,yc,x,y,c);
		if(p<0) {
			p=p+4*x+6;
		}
		else {
			p=p+4*(x-y)+10;
			y-=1;
		}
		x+=1;
	}
	if(x==y) {
		_plot_circle_points(xc,yc,x,y,c);
	}
}

